## Protobuf Deserialization

## Introduction

This section describes the `AKHQ Deserialization Configurator`.
The `AKHQ Deserialization Configurator` is part of the Kafka Service Operator
which responses for applying and deleting `AkhqConfig` configs.
The `AkhqConfig` is some `AKHQ` protobuf deserialization config and contains
information about a deserialization key, fully-qualified name of protobuf message and Kafka topic regular expression. 
The `AKHQ Deserialization Configurator` collects configs via Kubernetes Custom Resource (CR) - `AkhqConfig`, 
it watches CRs in all of predefined Kubernetes namespaces and managed them (create, update and delete `AkhqConfig` according creating, 
updating and deleting CR). Collected information allows build AKHQ deserialization config map and finally allows browse topic content 
as human-readable message on the Kafka UI.

## AkhqConfig custom resource overview

To create AKHQ deserialization config using `AKHQ Deserialization Configurator` client service should apply
`AkhqConfig` Kubernetes Custom Resource. This is a common example:

```yaml
apiVersion: qubership.org/v1
kind: AkhqConfig
metadata:
  name: example-akhq-config
spec:
  configs:
    - topic-regex: "my-topic.*"
      message-type: "tutorial.AddressBook"
      key-type: ""
      descriptor-file-base64: "CuMCCghteS5wcm90bxIIdHV0b3JpYWwi/AEKBlBlcnNvbhISCgRuYW1lGAEgASgJUgRuYW1lEg4KAmlkGAIgASgFUgJpZBIUCgVlbWFpbBgDIAEoCVIFZW1haWwSNAoGcGhvbmVzGAQgAygLMhwudHV0b3JpYWwuUGVyc29uLlBob25lTnVtYmVyUgZwaG9uZXMaVQoLUGhvbmVOdW1iZXISFgoGbnVtYmVyGAEgASgJUgZudW1iZXISLgoEdHlwZRgCIAEoDjIaLnR1dG9yaWFsLlBlcnNvbi5QaG9uZVR5cGVSBHR5cGUiKwoJUGhvbmVUeXBlEgoKBk1PQklMRRAAEggKBEhPTUUQARIICgRXT1JLEAIiNwoLQWRkcmVzc0Jvb2sSKAoGcGVvcGxlGAEgAygLMhAudHV0b3JpYWwuUGVyc29uUgZwZW9wbGVCDVoLLi9yZXNvdXJjZXNiBnByb3RvMw=="
    - topic-regex: "topic-1,topic-2"
      message-type: "com.qubership.Employee"
      descriptor-file-base64: "Cp8BCg5lbXBsb3llZS5wcm90bxIOY29tLm5ldGNyYWNrZXIiZgoIRW1wbG95ZWUSEgoEbmFtZRgBIAEoCVIEbmFtZRIOCgJpZBgCIAEoBVICaWQSFgoGc2FsYXJ5GAMgASgFUgZzYWxhcnkSHgoKZXhwZXJpZW5jZRgEIAEoBVIKZXhwZXJpZW5jZUINWgsuL2VtcGxveWVlc2IGcHJvdG8z"
```

`spec.configs` is an array of AKHQ deserialization configs.

`topic-regex` is a regular expression which will be used by AKHQ to select a Kafka topic for which the deserialization key will be applied.
The comma (`,`) symbol is allowed as a separator of topics names or regular expression. Under the hood, all comma symbols are replaced with
`|` and `topic-1,topic-2` will be replaced with valid regular expression `topic-1|topic-2`.
The `topic-regex` config must be unique for configs
array. It is possible to point intersecting regular expressions in configs array.
In this case, only first deserialization key will be applied.
`AkhqConfig` CR owner has a responsibility to avoid intersecting.

`message-type` is a fully-qualified name of protobuf message. Kafka is a key-value storage. This property is used for value
of Kafka message. For example, we have the following proto file

```protobuf
syntax = "proto3";
package com.qubership;

option java_package = "my.java.packege";

message Employee {
  string name = 1;
  int32 id = 2;  // Unique ID number for this person.
  int32 salary = 3;
  int32 experience = 4;
}
```

if value of Kafka message is serialised Employee message `com.qubership.Employee` should be used as `message-type`.

`key-type` is the same as `message-type` but used for Kafka message key. This config can be omitted if key is not serialised or `null`.  

`descriptor-file-base64` is a content of `desc` file in base64 format. `desc` file is a deserialization key for the particular protobuf file
and generated by protoc compiler.  

## AkhqConfig custom resource validation

`AkhqConfig` is invalid if contains two or more equal `topic-regex` or contains `descriptor-file-base64`
which can not be decoded from base64 format. 
